// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  TEACHER
  ADMIN
}

enum SubscriptionPlanName {
  FREE
  PRO
}

enum DocumentType {
  TEXTBOOK
  TEACHER_MATERIAL
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  PARTIALLY_COMPLETED
}

enum Difficulty {
  NB  // Nhận biết
  TH  // Thông hiểu
  VD  // Vận dụng
}

enum QuestionType {
  MCQ
  ESSAY
}

enum ActionType {
  EXAM_GENERATION
  LESSON_PLAN_GENERATION
  QUESTION_GENERATION
  GRADING
}

model User {
  id                String            @id @default(cuid())
  name              String
  email             String            @unique
  password          String
  role              UserRole          @default(TEACHER)
  subscriptionPlanId String
  subscriptionPlan  SubscriptionPlan  @relation(fields: [subscriptionPlanId], references: [id])
  usageCountDaily   Int               @default(0)
  usageCountMonthly Int               @default(0)
  lastUsageReset    DateTime?         @default(now())
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  uploadedDocuments Document[]  @relation("DocumentUploader")
  createdQuestions  Question[]  @relation("QuestionCreator")
  createdExams      Exam[]      @relation("ExamCreator")
  createdLessonPlans LessonPlan[] @relation("LessonPlanCreator")
  gradedSubmissions StudentSubmission[] @relation("SubmissionGrader")
  usageLogs         AIUsageLog[]

  @@index([email])
  @@map("users")
}

model SubscriptionPlan {
  id           String   @id @default(cuid())
  name         SubscriptionPlanName @unique
  dailyQuota   Int
  monthlyQuota Int
  price        Float    @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users        User[]

  @@map("subscription_plans")
}

model Subject {
  id        String   @id @default(cuid())
  name      String
  grade     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  documents  Document[]
  questions  Question[]
  exams      Exam[]
  lessonPlans LessonPlan[]

  @@unique([name, grade])
  @@map("subjects")
}

model Document {
  id              String            @id @default(cuid())
  subjectId       String
  subject         Subject           @relation(fields: [subjectId], references: [id])
  type            DocumentType
  content         String?           @db.LongText  // Made nullable - will be in chunks
  embedding       Json?             // Legacy - kept for backward compat
  chunkIndex      Int?               // Legacy - kept for backward compat
  originalFileName String?
  filePath        String?            // Path to original file
  fileSize        Int?
  mimeType        String?
  
  // Processing status
  status          ProcessingStatus?  @default(PENDING)
  processedAt     DateTime?
  errorMessage    String?            @db.LongText
  
  uploadedBy      String?            // User ID
  uploader        User?              @relation("DocumentUploader", fields: [uploadedBy], references: [id])
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  questions       Question[]
  chunks          Chunk[]            // NEW: Chunks from Python service

  @@index([subjectId])
  @@index([type])
  @@index([status])
  @@map("documents")
}

model Chunk {
  id              String       @id @default(cuid())
  documentId      String
  document        Document      @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Location metadata
  chapterNumber   Int?
  chapterTitle    String?
  pageStart       Int?
  pageEnd         Int?
  
  // Content
  content         String       @db.LongText
  contentLength   Int
  tokenCount      Int?
  
  // Embedding
  embedding       Json?        // Vector stored as JSON
  embeddingModel  String?      // "text-embedding-3-large"
  
  // Chunk metadata
  chunkIndex      Int
  chunkType       String       @default("TEXT")  // TEXT, TABLE, FORMULA, etc.
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  questions       Question[]   // Questions generated from this chunk
  
  @@index([documentId])
  @@index([chapterNumber])
  @@map("chunks")
}

model Question {
  id                String       @id @default(cuid())
  subjectId         String
  subject           Subject      @relation(fields: [subjectId], references: [id])
  grade             Int
  difficulty        Difficulty
  type              QuestionType
  content           String        @db.LongText
  options           Json?        // For MCQ: array of options
  correctAnswer     String       // For MCQ: option index/letter, for Essay: rubric
  explanation       String?      @db.LongText
  
  // Source tracking (NEW)
  sourceDocumentId  String?
  sourceDocument    Document?    @relation(fields: [sourceDocumentId], references: [id])
  sourceChunkId     String?       // Link to source chunk
  sourceChunk       Chunk?        @relation(fields: [sourceChunkId], references: [id])
  chapterNumber     Int?          // For filtering by chapter
  
  createdBy         String?      // User ID
  creator           User?        @relation("QuestionCreator", fields: [createdBy], references: [id])
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  examQuestions     ExamQuestion[]

  @@index([subjectId, grade])
  @@index([difficulty])
  @@index([type])
  @@index([chapterNumber])
  @@index([sourceChunkId])
  @@map("questions")
}

model Exam {
  id          String   @id @default(cuid())
  subjectId   String
  subject     Subject  @relation(fields: [subjectId], references: [id])
  grade       Int
  duration    Int      // minutes
  title       String?
  description String?
  createdBy   String?  // User ID
  creator     User?    @relation("ExamCreator", fields: [createdBy], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  questions   ExamQuestion[]
  submissions StudentSubmission[]

  @@index([subjectId, grade])
  @@map("exams")
}

model ExamQuestion {
  id         String   @id @default(cuid())
  examId     String
  exam       Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  questionId String
  question   Question @relation(fields: [questionId], references: [id])
  order      Int
  points     Float    @default(1.0)
  createdAt  DateTime @default(now())

  @@unique([examId, questionId])
  @@index([examId])
  @@map("exam_questions")
}

model StudentSubmission {
  id        String   @id @default(cuid())
  examId    String
  exam      Exam     @relation(fields: [examId], references: [id])
  studentName String?
  answers   Json     // { questionId: answer }
  score     Float?
  feedback  String?  @db.LongText
  gradedBy  String?  // User ID
  grader    User?    @relation("SubmissionGrader", fields: [gradedBy], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([examId])
  @@map("student_submissions")
}

model LessonPlan {
  id          String   @id @default(cuid())
  subjectId   String
  subject     Subject  @relation(fields: [subjectId], references: [id])
  grade       Int
  title       String
  objectives  Json     // Array of objectives
  activities  Json     // { teacher: [], student: [] }
  assessment  Json     // Assessment criteria
  content     String?  @db.LongText  // Full lesson plan content
  createdBy   String?  // User ID
  creator     User?    @relation("LessonPlanCreator", fields: [createdBy], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([subjectId, grade])
  @@map("lesson_plans")
}

model AIUsageLog {
  id         String     @id @default(cuid())
  userId     String
  user       User       @relation(fields: [userId], references: [id])
  actionType ActionType
  tokenUsed  Int
  createdAt  DateTime   @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("ai_usage_logs")
}

