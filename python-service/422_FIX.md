# ğŸ”§ Fix 422 Unprocessable Entity Error

## âŒ Váº¥n Ä‘á»

```
422 Unprocessable Entity khi POST /api/v1/process
NhÆ°ng váº«n cÃ³ data insert vÃ o documents table
```

## ğŸ” NguyÃªn nhÃ¢n

**FastAPI khÃ´ng thá»ƒ parse Pydantic model tá»« multipart/form-data**

Khi cÃ³ `file: UploadFile`, cÃ¡c field khÃ¡c pháº£i lÃ  `Form()` chá»© khÃ´ng pháº£i Pydantic `BaseModel`.

**Lá»—i cÅ©:**
```python
@app.post("/api/v1/process")
async def process_document(
    request: ProcessDocumentRequest,  # âŒ Pydantic model
    file: UploadFile = File(...),
):
```

FastAPI cá»‘ parse `ProcessDocumentRequest` tá»« JSON body, nhÆ°ng request lÃ  multipart/form-data â†’ 422 error.

## âœ… Giáº£i phÃ¡p

**DÃ¹ng `Form()` fields thay vÃ¬ Pydantic model:**

```python
@app.post("/api/v1/process")
async def process_document(
    file: UploadFile = File(...),
    document_id: str = Form(...),      # âœ… Form field
    subject_id: str = Form(...),        # âœ… Form field
    document_type: str = Form(...),     # âœ… Form field
    user_id: Optional[str] = Form(None),
    original_filename: Optional[str] = Form(None),
):
```

## ğŸ“‹ ÄÃ£ Fix

1. âœ… XÃ³a `ProcessDocumentRequest` Pydantic model
2. âœ… DÃ¹ng `Form()` fields cho táº¥t cáº£ parameters (trá»« file)
3. âœ… Update cáº£ `/api/v1/process` vÃ  `/api/v1/process-sync`

## ğŸ” Vá» viá»‡c "váº«n insert Ä‘Æ°á»£c data"

CÃ³ thá»ƒ do:
1. **Background task váº«n cháº¡y** tá»« láº§n request trÆ°á»›c (trÆ°á»›c khi cÃ³ 422)
2. **CÃ³ request khÃ¡c** Ä‘Ã£ thÃ nh cÃ´ng
3. **Local processing fallback** tá»« NestJS

**Kiá»ƒm tra:**
```sql
-- Check document status
SELECT id, originalFileName, status, processedAt, errorMessage 
FROM documents 
WHERE id = 'cmjwrryyj0001b99bwfvn5sun'
ORDER BY createdAt DESC;
```

## ğŸš€ Test sau khi fix

```bash
# Restart Python service
cd python-service
source venv/bin/activate
uvicorn app.main:app --reload

# Test tá»« NestJS
# Upload document qua frontend
```

## âœ… Verify

Sau khi fix, request sáº½:
- âœ… Nháº­n Ä‘Æ°á»£c 200 OK (thay vÃ¬ 422)
- âœ… Background task cháº¡y vÃ  insert chunks
- âœ… Document status update: PENDING â†’ PROCESSING â†’ COMPLETED

---

**Sau khi restart Python service, test láº¡i upload document!** ğŸ¯

